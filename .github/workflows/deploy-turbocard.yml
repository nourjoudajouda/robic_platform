name: Deploy Turbocard

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'README.md'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Turbocard
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for composer changes
        id: composer_changed
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          elif git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -qE 'composer\.(json|lock)$'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for migration changes
        id: migrations_changed
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          elif git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -qE 'database/migrations/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.CPANEL_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.CPANEL_HOST }} >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SSH_PASSPHRASE: ${{ secrets.CPANEL_SSH_PASSPHRASE }}
        run: |
          if [ -n "$SSH_PASSPHRASE" ]; then
            apt-get update && apt-get install -y sshpass
            sshpass -p "$SSH_PASSPHRASE" rsync -avz --delete \
              -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
              --exclude='.git' \
              --exclude='.github' \
              --exclude='node_modules' \
              --exclude='storage' \
              --exclude='.env' \
              --exclude='vendor' \
              ./ ${{ secrets.CPANEL_USER }}@${{ secrets.CPANEL_HOST }}:${{ secrets.CPANEL_PATH }}
          else
            rsync -avz --delete \
              -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
              --exclude='.git' \
              --exclude='.github' \
              --exclude='node_modules' \
              --exclude='storage' \
              --exclude='.env' \
              --exclude='vendor' \
              ./ ${{ secrets.CPANEL_USER }}@${{ secrets.CPANEL_HOST }}:${{ secrets.CPANEL_PATH }}
          fi

      - name: Setup .env file
        env:
          SSH_PASSPHRASE: ${{ secrets.CPANEL_SSH_PASSPHRASE }}
        run: |
          if [ -n "$SSH_PASSPHRASE" ]; then
            sshpass -p "$SSH_PASSPHRASE" ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.CPANEL_USER }}@${{ secrets.CPANEL_HOST }} "cd ${{ secrets.CPANEL_PATH }} && \
              if [ ! -f .env ]; then \
                if [ -f .env.example ]; then \
                  cp .env.example .env; \
                else \
                  touch .env; \
                fi; \
                php artisan key:generate --force; \
              fi && \
              sed -i 's/^DB_DATABASE=.*/DB_DATABASE=${{ secrets.DB_DATABASE }}/' .env || echo 'DB_DATABASE=${{ secrets.DB_DATABASE }}' >> .env && \
              sed -i 's/^DB_USERNAME=.*/DB_USERNAME=${{ secrets.DB_USERNAME }}/' .env || echo 'DB_USERNAME=${{ secrets.DB_USERNAME }}' >> .env && \
              sed -i 's/^DB_PASSWORD=.*/DB_PASSWORD=${{ secrets.DB_PASSWORD }}/' .env || echo 'DB_PASSWORD=${{ secrets.DB_PASSWORD }}' >> .env"
          else
            ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.CPANEL_USER }}@${{ secrets.CPANEL_HOST }} "cd ${{ secrets.CPANEL_PATH }} && \
              if [ ! -f .env ]; then \
                if [ -f .env.example ]; then \
                  cp .env.example .env; \
                else \
                  touch .env; \
                fi; \
                php artisan key:generate --force; \
              fi && \
              sed -i 's/^DB_DATABASE=.*/DB_DATABASE=${{ secrets.DB_DATABASE }}/' .env || echo 'DB_DATABASE=${{ secrets.DB_DATABASE }}' >> .env && \
              sed -i 's/^DB_USERNAME=.*/DB_USERNAME=${{ secrets.DB_USERNAME }}/' .env || echo 'DB_USERNAME=${{ secrets.DB_USERNAME }}' >> .env && \
              sed -i 's/^DB_PASSWORD=.*/DB_PASSWORD=${{ secrets.DB_PASSWORD }}/' .env || echo 'DB_PASSWORD=${{ secrets.DB_PASSWORD }}' >> .env"
          fi

      - name: Install Composer Dependencies (if changed)
        if: steps.composer_changed.outputs.changed == 'true'
        env:
          SSH_PASSPHRASE: ${{ secrets.CPANEL_SSH_PASSPHRASE }}
        run: |
          if [ -n "$SSH_PASSPHRASE" ]; then
            sshpass -p "$SSH_PASSPHRASE" ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.CPANEL_USER }}@${{ secrets.CPANEL_HOST }} "cd ${{ secrets.CPANEL_PATH }} && \
              composer install --no-dev --optimize-autoloader --no-interaction"
          else
            ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.CPANEL_USER }}@${{ secrets.CPANEL_HOST }} "cd ${{ secrets.CPANEL_PATH }} && \
              composer install --no-dev --optimize-autoloader --no-interaction"
          fi

      - name: Run Database Migrations (if changed)
        if: steps.migrations_changed.outputs.changed == 'true'
        env:
          SSH_PASSPHRASE: ${{ secrets.CPANEL_SSH_PASSPHRASE }}
        run: |
          if [ -n "$SSH_PASSPHRASE" ]; then
            sshpass -p "$SSH_PASSPHRASE" ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.CPANEL_USER }}@${{ secrets.CPANEL_HOST }} "cd ${{ secrets.CPANEL_PATH }} && \
              php artisan migrate --force"
          else
            ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.CPANEL_USER }}@${{ secrets.CPANEL_HOST }} "cd ${{ secrets.CPANEL_PATH }} && \
              php artisan migrate --force"
          fi

      - name: Run deployment commands on server
        env:
          SSH_PASSPHRASE: ${{ secrets.CPANEL_SSH_PASSPHRASE }}
        run: |
          if [ -n "$SSH_PASSPHRASE" ]; then
            sshpass -p "$SSH_PASSPHRASE" ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.CPANEL_USER }}@${{ secrets.CPANEL_HOST }} "cd ${{ secrets.CPANEL_PATH }} && \
              php artisan config:cache && \
              php artisan route:cache && \
              php artisan view:cache && \
              php artisan queue:restart || true"
          else
            ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.CPANEL_USER }}@${{ secrets.CPANEL_HOST }} "cd ${{ secrets.CPANEL_PATH }} && \
              php artisan config:cache && \
              php artisan route:cache && \
              php artisan view:cache && \
              php artisan queue:restart || true"
          fi

      - name: Clear application cache
        env:
          SSH_PASSPHRASE: ${{ secrets.CPANEL_SSH_PASSPHRASE }}
        run: |
          if [ -n "$SSH_PASSPHRASE" ]; then
            sshpass -p "$SSH_PASSPHRASE" ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.CPANEL_USER }}@${{ secrets.CPANEL_HOST }} "cd ${{ secrets.CPANEL_PATH }} && \
              php artisan cache:clear && \
              php artisan optimize:clear && \
              php artisan optimize"
          else
            ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.CPANEL_USER }}@${{ secrets.CPANEL_HOST }} "cd ${{ secrets.CPANEL_PATH }} && \
              php artisan cache:clear && \
              php artisan optimize:clear && \
              php artisan optimize"
          fi

      - name: Deployment notification
        if: success()
        run: |
          echo "✅ Deployment to Turbocard completed successfully!"

      - name: Deployment failure notification
        if: failure()
        run: |
          echo "❌ Deployment to Turbocard failed!"

