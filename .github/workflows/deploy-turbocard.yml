name: Deploy Turbocard

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'README.md'

  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Turbocard
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ جلب الكود
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2️⃣ تفعيل SSH باستخدام private key (بدون passphrase)
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.CPANEL_SSH_KEY }}

      # 3️⃣ إضافة السيرفر إلى known_hosts
      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.CPANEL_HOST }} >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      # 4️⃣ رفع الملفات إلى السيرفر
      - name: Deploy files to server
        run: |
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='vendor' \
            --exclude='.env' \
            ./ ${{ secrets.CPANEL_USER }}@${{ secrets.CPANEL_HOST }}:${{ secrets.CPANEL_PATH }}

      # 5️⃣ التأكد من وجود .env وإنشاؤه إن لم يكن موجودًا
      - name: Setup .env file
        run: |
          ssh ${{ secrets.CPANEL_USER }}@${{ secrets.CPANEL_HOST }} "
            cd ${{ secrets.CPANEL_PATH }} || exit 1

            if [ ! -f .env ]; then
              if [ -f .env.example ]; then
                cp .env.example .env
              else
                touch .env
              fi
            fi

            grep -q '^APP_KEY=' .env || php artisan key:generate --force

            sed -i 's/^DB_DATABASE=.*/DB_DATABASE=${{ secrets.DB_DATABASE }}/' .env || echo 'DB_DATABASE=${{ secrets.DB_DATABASE }}' >> .env
            sed -i 's/^DB_USERNAME=.*/DB_USERNAME=${{ secrets.DB_USERNAME }}/' .env || echo 'DB_USERNAME=${{ secrets.DB_USERNAME }}' >> .env
            sed -i 's/^DB_PASSWORD=.*/DB_PASSWORD=${{ secrets.DB_PASSWORD }}/' .env || echo 'DB_PASSWORD=${{ secrets.DB_PASSWORD }}' >> .env
          "

      # 6️⃣ تثبيت Composer + تشغيل Migrations + Optimization
      - name: Run Laravel commands
        run: |
          ssh ${{ secrets.CPANEL_USER }}@${{ secrets.CPANEL_HOST }} "
            cd ${{ secrets.CPANEL_PATH }} || exit 1

            composer install --no-dev --optimize-autoloader --no-interaction
            php artisan migrate --force
            php artisan optimize
          "

      # 7️⃣ رسالة نجاح
      - name: Deployment success
        if: success()
        run: echo "✅ Deployment to Turbocard completed successfully!"

      # 8️⃣ رسالة فشل
      - name: Deployment failed
        if: failure()
        run: echo "❌ Deployment to Turbocard failed!"
